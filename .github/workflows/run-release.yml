name: Sync OpenWRT Releases

on:
  schedule:
    - cron: '0 0 */3 * *' # Проверка новых релизов раз в три дня
  workflow_dispatch: # Возможность вручную запустить Action

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4


      - name: extract release tag
        run: |
         python -c "
         import requests
         from bs4 import BeautifulSoup

         def get_release_tag_between_toggle_and_quote(url):
         headers = {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          
          }
            response = requests.get(url, headers=headers)
          if response.status_code == 200:
            soup = BeautifulSoup(response.content, 'html.parser')
        
          # Поиск кнопки с id, начинающимся с "toggle-commit-"
           button = soup.find('button', id=lambda x: x and x.startswith('toggle-commit-'))
          if button:
            button_id = button['id']
            # Извлекаем значение между 'toggle-commit-' и кавычкой
            release_tag = button_id[len('toggle-commit-'):].split('\"')[0]
            print(f'Release Tag: {release_tag}')
         else:
            print("Кнопка не найдена.")
         else:
            print(f"Ошибка запроса: {response.status_code}")
          
      - name: Check if release exists in your repo
        id: check_release
        run: |
          curl -s https://api.github.com/samara15321/awg-immortalwrt/releases/tags/${{ steps.get_release.outputs.release_tag }} | jq -r .tag_name || echo "Not found"
      - name: Create release in your repo
        if: steps.check_release.outputs.tag_name == 'Not found'
        run: |
          ART="
            _______                     ________        __
          |       |.-----.-----.-----.|  |  |  |.----.|  |_
          |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
          |_______||   __|_____|__|__||________||__|  |____|
                    |__| A M N E Z I A   W I R E G U A R D
          -----------------------------------------------------
          OpenWrt ${{ steps.get_release.outputs.release_tag }}
          -----------------------------------------------------"
          curl -X POST https://api.github.com/repos/samara15321/awg-immortalwrt/releases \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "tag_name": "'${{ steps.get_release.outputs.release_tag }}'",
              "name": "Build amnezia wg for all devices with openwrt '${{ steps.get_release.outputs.release_tag }}'",
              "body": "'"${ART}"'\n\nAutomatically created release for OpenWRT '${{ steps.get_release.outputs.release_tag }}'."
            }'
